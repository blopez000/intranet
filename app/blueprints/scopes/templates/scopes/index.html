{% extends "base.html" %}
{% block title %}Accesos Recinto/Cuenta{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Accesos por Recinto / Cuenta</h4>
  </div>

  <!-- Filtros -->
  <form class="row g-2 mb-3" method="get">
    <div class="col-sm-4">
      <label class="form-label">Usuario</label>
      <input class="form-control" name="q_user" value="{{ q_user }}" placeholder="email o nombre">
    </div>
    <div class="col-sm-3">
      <label class="form-label">Recinto</label>
      <input class="form-control" name="q_rec" value="{{ q_rec }}" placeholder="id o nombre">
    </div>
    <div class="col-sm-3">
      <label class="form-label">Cuenta</label>
      <input class="form-control" name="q_cue" value="{{ q_cue }}" placeholder="*, BAT, BRF, ...">
    </div>
    <div class="col-sm-2 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="only_active" value="1" id="only_active" {% if only_active %}checked{% endif %}>
        <label class="form-check-label" for="only_active">Solo activas</label>
      </div>
    </div>
    <div class="col-12">
      <button class="btn btn-primary">Filtrar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('scopes.index') }}">Limpiar</a>
    </div>
  </form>

  <!-- Alta rápida -->
  <div class="card mb-3">
    <div class="card-header">Agregar acceso</div>
    <div class="card-body">
      <form class="row g-2" method="post" action="{{ url_for('scopes.create') }}">
        {# Si NO usas CSRF, puedes eliminar la línea de abajo #}
        {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}

        <div class="col-md-4">
          <label class="form-label">Usuario</label>
          <select class="form-select" name="user_id" required>
            <option value="" selected disabled>Selecciona...</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.email }} — {{ u.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Recinto</label>
          <select class="form-select" name="recinto_id" id="recintoSel" required>
            <option value="" selected disabled>Selecciona...</option>
            {% for r in recintos %}
              <option value="{{ r.id }}">{{ r.id }} — {{ r.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Cuenta (usa * para todas)</label>
          <input class="form-control" list="cuentasList" name="cuenta_area" id="cuentaInput" placeholder="*, BAT, BRF, ...">
          <datalist id="cuentasList"></datalist>
          <div class="form-text">Las sugerencias se cargan según el recinto.</div>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-success w-100">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Usuario</th>
          <th>Recinto</th>
          <th>Cuenta</th>
          <th>Activo</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for rec, u, r in rows %}
        <tr>
          <td>{{ u.email }}<br><small class="text-secondary">{{ u.name }}</small></td>
          <td>{{ r.id }} — {{ r.nombre }}</td>
          <td><code>{{ rec.cuenta_area }}</code></td>
          <td>
            {% if rec.is_active %}<span class="badge text-bg-success">Sí</span>
            {% else %}<span class="badge text-bg-secondary">No</span>{% endif %}
          </td>
          <td class="text-end">
            <form method="post" action="{{ url_for('scopes.toggle') }}" class="d-inline">
              {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <input type="hidden" name="user_id" value="{{ rec.user_id }}">
              <input type="hidden" name="recinto_id" value="{{ rec.recinto_id }}">
              <input type="hidden" name="cuenta_area" value="{{ rec.cuenta_area }}">
              <button class="btn btn-outline-warning btn-sm">Activar/Desactivar</button>
            </form>
            <form method="post" action="{{ url_for('scopes.delete') }}" class="d-inline" onsubmit="return confirm('¿Eliminar asignación?');">
              {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <input type="hidden" name="user_id" value="{{ rec.user_id }}">
              <input type="hidden" name="recinto_id" value="{{ rec.recinto_id }}">
              <input type="hidden" name="cuenta_area" value="{{ rec.cuenta_area }}">
              <button class="btn btn-outline-danger btn-sm">Eliminar</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center text-secondary">Sin resultados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.getElementById('recintoSel')?.addEventListener('change', async (e) => {
  const rid = e.target.value;
  const dl = document.getElementById('cuentasList');
  dl.innerHTML = '';
  if (!rid) return;
  const res = await fetch(`{{ url_for('scopes.cuentas_suggest') }}?recinto_id=${rid}`);
  const data = await res.json();
  data.forEach(v => { const opt = document.createElement('option'); opt.value = v; dl.appendChild(opt); });
});
</script>
{% endblock %}
